---
title: "STOR 538 final"
author: "Riham Abdu"
date: "2025-11-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(dplyr)
library(janitor)
library(knitr)
library(ggplot2)
library(scales)
```

```{r}
# Load and preview dataset 
df <- read_excel("desktop/Combined_Data.xlsx")
head(df)
```

```{r}
# Convert all variables to categorical (factors)
df1 <- df %>%
  mutate(
    `Shot Type` = factor(`Shot Type`),
    `Defender Distance` = factor(`Defender Distance`),
    Location = factor(Location),
    Position = factor(Position),
    Hand = factor(as.numeric(Hand), 
                  levels = c(0, 1), 
                  labels = c("Down", "Up")),
    Result = factor(Result, levels = c("Miss", "Make"))
  )
```

```{r}
# Check structure 
str(df1)
```

```{r}
# Check summary
summary(df1)
```
```{r}
# List of variables
vars <- c("Shot Type", "Defender Distance", "Hand", "Result", "Location", "Position")

table <- bind_rows(
  lapply(vars, function(v) {
    df1 %>% 
      tabyl(!!sym(v)) %>% 
      mutate(
        Variable = v,
        percent = round(percent * 100, 1)
      ) %>%
      rename(Category = 1, Count = n, Percent = percent)
  })
)

# Reorder columns
table <- table %>%
  select(Variable, Category, Count, Percent)

table
# Convert table to csv 
#write.csv(table, "summary_table.csv", row.names = FALSE)
```

```{r}
# Figure 1: Success rate by Shot Type and Defender Distance 
# Compute success rates
tile_data <- df1 %>%
  group_by(`Shot Type`, `Defender Distance`) %>%
  summarise(
    make_rate = mean(Result == "Make")
  )

# Tile plot
ggplot(tile_data, aes(x = `Defender Distance`, y = `Shot Type`, fill = make_rate)) +
  geom_tile(color = "white", linewidth = 1.2) +
  geom_text(aes(label = percent(make_rate, accuracy = 0.1)), size = 5) +
  scale_fill_gradient2(
    low = "#b2182b",   # red
    mid = "white",
    high = "#2166ac",  # dark blue
    midpoint = 0.5,
    limits = c(0.20,0.80),
    name = "Make %"
  ) +
  labs(
    title = "Success Rate by Shot Type & Defender Distance",
    x = "Defender Distance",
    y = "Shot Type"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5)
  )
# Save Figure 1
#ggsave("Figure1_TilePlot.png", fig1, width = 10, height = 6, dpi = 300)
```



```{r}
# FIGURE 2: Shot success across Contest Difficulty Index (CDI)
# Create CDI variable and compute make percentage
df2 <- df1 %>%
  mutate(
    DistanceScore = case_when(
      `Defender Distance` == "Loose" ~ 0,
      `Defender Distance` == "Moderate" ~ 1,
      `Defender Distance` == "Tight" ~ 2
    ),
    HandScore = ifelse(Hand == "Up", 1, 0),
    CDI = DistanceScore + HandScore
  )
```

```{r}
# Compute mean make % by CDI level
fig2_df <- df2 %>%
  group_by(CDI) %>%
  summarise(
    make_pct = mean(Result == "Make"),
    attempts = n()
  )
# Create the CDI line plot
ggplot(fig2_df, aes(x = CDI, y = make_pct)) +
  geom_line(size = 1.4, color = "#4575B4") +
  geom_point(size = 4, color = "#D73027") +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = 0:3) +
  labs(
    title = "Shot Success Rate Across Contest Difficulty Levels",
    x = "Contest Difficulty Index (CDI)",
    y = "Make Percentage"
  ) +
  theme_minimal(base_size = 16) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))
# Save Figure 2
#ggsave("Figure2_CDI.png", fig2, width = 10, height = 6, dpi = 300)
```



